// =============================================================================
// WATU KOBU - Debt Collector Management System
// Prisma Schema - PostgreSQL (Supabase Compatible)
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  ADMIN
  MANAGER
  COLLECTOR
}

enum AssetStatus {
  LANCAR
  MACET
  JANJI_BAYAR
}

enum ValidationStatus {
  PENDING
  APPROVED
  REJECTED
}

// =============================================================================
// USER MODEL
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Hashed password
  name          String
  role          Role      @default(COLLECTOR)
  employeeId    String?   @unique // NIK Karyawan
  area          String?   // Area Tugas (Misal: Jakarta Selatan)
  avatarUrl     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignedAssets Asset[]        // Assets directly assigned to this collector
  assignments    Assignment[]
  visitReports   VisitReport[]
  paymentReports PaymentReport[]
}

// =============================================================================
// BRANCH MODEL
// =============================================================================

model Branch {
  id        String   @id @default(cuid())
  name      String   // Misal: "KCP Bogor"
  region    String   // Misal: "Jawa Barat"
  assets    Asset[]
  createdAt DateTime @default(now())
}

// =============================================================================
// ASSET MODEL (Debitur)
// =============================================================================

model Asset {
  id                String      @id @default(cuid())
  loanId            String      @unique // Loan ID from Bank
  debtorName        String      // Nama Debitur
  
  // Address & Contact
  identityAddress   String?     // Alamat KTP
  officeAddress     String?     // Alamat Kantor
  phone             String?
  officePhone       String?
  
  // Emergency Contact
  emergencyName     String?
  emergencyPhone    String?
  emergencyAddress  String?
  
  // Location
  locationLat       Float?
  locationLng       Float?
  vehiclePlate      String?
  
  // Credit Info
  spkStatus         String      @default("AKTIF") // AKTIF, PASIF
  creditType        String?
  collateralAddress String?
  
  // Financial Data
  initialPlafond    Float       @default(0)
  realizationDate   DateTime?
  maturityDate      DateTime?
  principalBalance  Float       @default(0)
  interestArrears   Float       @default(0)
  penaltyArrears    Float       @default(0)
  principalArrears  Float       @default(0)
  totalArrears      Float       @default(0)
  totalPayoff       Float       @default(0)
  
  status            AssetStatus @default(LANCAR)
  branchId          String?
  branch            Branch?     @relation(fields: [branchId], references: [id])
  
  // Direct collector assignment for simpler queries
  collectorId       String?
  collector         User?       @relation(fields: [collectorId], references: [id])
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  assignments       Assignment[]
  visitReports      VisitReport[]
  paymentReports    PaymentReport[]

  @@index([loanId])
  @@index([debtorName])
  @@index([phone])
  @@index([vehiclePlate])
  @@index([status])
  @@index([branchId])
  @@index([collectorId])
}

// =============================================================================
// ASSIGNMENT MODEL (Penugasan)
// =============================================================================

model Assignment {
  id          String   @id @default(cuid())
  userId      String
  assetId     String
  assignedAt  DateTime @default(now())
  dueDate     DateTime?
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED

  user        User     @relation(fields: [userId], references: [id])
  asset       Asset    @relation(fields: [assetId], references: [id])

  @@index([userId])
  @@index([assetId])
  @@index([status])
}

// =============================================================================
// VISIT REPORT MODEL (Laporan Kunjungan)
// =============================================================================

model VisitReport {
  id              String           @id @default(cuid())
  assetId         String
  collectorId     String
  timestamp       DateTime         @default(now())
  
  outcome         String           // BERTEMU, TIDAK_BERTEMU, PINDAH
  notes           String?
  gpsLat          Float?
  gpsLng          Float?
  evidencePhoto   String?          // URL Foto Bukti
  
  statusValidation ValidationStatus @default(PENDING)
  
  asset           Asset            @relation(fields: [assetId], references: [id])
  collector       User             @relation(fields: [collectorId], references: [id])

  @@index([assetId])
  @@index([collectorId])
  @@index([statusValidation])
  @@index([timestamp])
}

// =============================================================================
// PAYMENT REPORT MODEL (Laporan Pembayaran)
// =============================================================================

model PaymentReport {
  id              String           @id @default(cuid())
  assetId         String
  collectorId     String
  timestamp       DateTime         @default(now())
  
  amount          Float
  method          String           // CASH, TRANSFER, VA
  proofPhoto      String?          // URL Bukti Struk
  
  statusValidation ValidationStatus @default(PENDING)

  asset           Asset            @relation(fields: [assetId], references: [id])
  collector       User             @relation(fields: [collectorId], references: [id])

  @@index([assetId])
  @@index([collectorId])
  @@index([statusValidation])
  @@index([timestamp])
}
