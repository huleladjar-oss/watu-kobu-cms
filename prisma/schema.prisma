// =============================================================================
// WATU KOBU - Debt Collector Management System
// Prisma Schema - PostgreSQL (Supabase Compatible)
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  ADMIN
  MANAGER
  COLLECTOR
}

enum AssetStatus {
  LANCAR
  MACET
  JANJI_BAYAR
}

enum ValidationStatus {
  PENDING
  APPROVED
  REJECTED
}

// =============================================================================
// USER MODEL
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Hashed password
  name          String
  role          Role      @default(COLLECTOR)
  employeeId    String?   @unique // NIK Karyawan
  area          String?   // Area Tugas (Misal: Jakarta Selatan)
  phone         String?   // Nomor WhatsApp / Telepon
  address       String?   // Alamat Domisili
  avatarUrl     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignedAssets Asset[]        // Assets directly assigned to this collector
  assignments    Assignment[]
  visitReports   VisitReport[]
  paymentReports PaymentReport[]
}

// =============================================================================
// BRANCH MODEL
// =============================================================================

model Branch {
  id        String   @id @default(cuid())
  name      String   // Misal: "KCP Bogor"
  region    String   // Misal: "Jawa Barat"
  assets    Asset[]
  createdAt DateTime @default(now())
}

// =============================================================================
// ASSET MODEL (Debitur NPL)
// =============================================================================

model Asset {
  id                      String      @id @default(cuid())
  
  // Core Fields
  nomorAccount            String      @unique // NOMOR ACCOUNT
  namaDebitur             String              // NAMA DEBITUR
  namaKreditur            String?             // NAMA KREDITUR (nama bank/lembaga pemberi kredit)
  
  // Branch Info
  kantorCabang            String?             // KANTOR CABANG
  kanwil                  String?             // KANWIL
  kelolaanTerbitSpk       String      @default("AKTIF") // KELOLAAN TERBIT SPK (AKTIF/PASIF)
  jenisKredit             String?             // JENIS KREDIT
  
  // Address
  alamatAgunan            String?             // ALAMAT AGUNAN
  alamatKtpDebitur        String?             // ALAMAT KTP DEBITUR
  alamatKantorDebitur     String?             // ALAMAT KANTOR DEBITUR
  
  // Contact
  nomorHp1Debitur         String?             // NOMOR HP 1 DEBITUR
  nomorHp2Debitur         String?             // NOMOR HP 2 DEBITUR
  nomorTeleponKantor      String?             // NOMOR TELEPON KANTOR
  
  // Emergency Contact
  namaEmergencyKontak     String?             // NAMA EMERGENCY KONTAK
  nomorTeleponEmergency   String?             // NOMOR TELEPON EMERGENCY KONTAK
  alamatEmergencyKontak   String?             // ALAMAT EMERGENCY KONTAK
  
  // Financial - Plafond & Dates
  plafondAwal             Float       @default(0)   // PLAFOND AWAL
  tanggalRealisasi        String?                   // TANGGAL REALISASI
  tanggalJatuhTempo       String?                   // TANGGAL JATUH TEMPO
  
  // Financial - Balances & Arrears
  saldoPokok              Float       @default(0)   // SALDO POKOK / CBAL
  tunggakanBunga          Float       @default(0)   // TUNGGAKAN BUNGA
  tunggakanDenda          Float       @default(0)   // TUNGGAKAN DENDA
  tunggakanAngsuran       Float       @default(0)   // TUNGGAKAN ANGSURAN
  totalTunggakan          Float       @default(0)   // TOTAL TUNGGAKAN
  lunasTunggakan          Float       @default(0)   // LUNAS TUNGGAKAN
  lunasKredit             Float       @default(0)   // LUNAS KREDIT
  
  // System Fields
  status                  AssetStatus @default(LANCAR)
  branchId                String?
  branch                  Branch?     @relation(fields: [branchId], references: [id])
  
  // Direct collector assignment
  collectorId             String?
  collector               User?       @relation(fields: [collectorId], references: [id])
  
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  // Relations
  assignments             Assignment[]
  visitReports            VisitReport[]
  paymentReports          PaymentReport[]

  @@index([nomorAccount])
  @@index([namaDebitur])
  @@index([nomorHp1Debitur])
  @@index([kantorCabang])
  @@index([status])
  @@index([branchId])
  @@index([collectorId])
}

// =============================================================================
// ASSIGNMENT MODEL (Penugasan)
// =============================================================================

model Assignment {
  id          String   @id @default(cuid())
  userId      String
  assetId     String
  assignedAt  DateTime @default(now())
  dueDate     DateTime?
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED

  user        User     @relation(fields: [userId], references: [id])
  asset       Asset    @relation(fields: [assetId], references: [id])

  @@index([userId])
  @@index([assetId])
  @@index([status])
}

// =============================================================================
// VISIT REPORT MODEL (Laporan Kunjungan)
// =============================================================================

model VisitReport {
  id              String           @id @default(cuid())
  assetId         String
  collectorId     String
  timestamp       DateTime         @default(now())
  
  outcome         String           // BERTEMU, TIDAK_BERTEMU, PINDAH
  notes           String?
  gpsLat          Float?
  gpsLng          Float?
  evidencePhoto   String?          // URL Foto Bukti
  
  statusValidation ValidationStatus @default(PENDING)
  
  asset           Asset            @relation(fields: [assetId], references: [id])
  collector       User             @relation(fields: [collectorId], references: [id])

  @@index([assetId])
  @@index([collectorId])
  @@index([statusValidation])
  @@index([timestamp])
}

// =============================================================================
// PAYMENT REPORT MODEL (Laporan Pembayaran)
// =============================================================================

model PaymentReport {
  id              String           @id @default(cuid())
  assetId         String
  collectorId     String
  timestamp       DateTime         @default(now())
  
  amount          Float
  method          String           // CASH, TRANSFER, VA
  proofPhoto      String?          // URL Bukti Struk
  
  statusValidation ValidationStatus @default(PENDING)

  asset           Asset            @relation(fields: [assetId], references: [id])
  collector       User             @relation(fields: [collectorId], references: [id])

  @@index([assetId])
  @@index([collectorId])
  @@index([statusValidation])
  @@index([timestamp])
}
